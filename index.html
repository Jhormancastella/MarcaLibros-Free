<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarcaLibros Personalizados - Crea Separadores √önicos</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dipv76dpn/image/upload/v1759597977/undefined_Quiero_una_mezcla_de_d4pb5v.png">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --accent: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --success: #4cc9f0;
      --warning: #f8961e;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 16px;
      --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      --box-shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.18);
      --transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      --card-bg: white;
      --text-color: #212529;
      --text-muted: #6c757d;
    }
    
    /* Modo oscuro */
    body.dark-mode {
      --primary: #5a7aff;
      --primary-dark: #4c6cf0;
      --secondary: #8c2bd6;
      --accent: #ff3b94;
      --light: #121212;
      --dark: #f8f9fa;
      --success: #5ed5f5;
      --warning: #ffa94d;
      --gray: #a0a0a0;
      --gray-light: #2d2d2d;
      --bg-gradient: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      --card-bg: #2d2d2d;
      --text-color: #f8f9fa;
      --text-muted: #a0a0a0;
      --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      --box-shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.4);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding: 20px;
      background: var(--bg-gradient);
      min-height: 100vh;
      max-width: 1200px;
      margin: 0 auto;
      color: var(--text-color);
      line-height: 1.6;
      opacity: 0;
      transform: translateY(20px);
      transition: background 0.5s ease, color 0.3s ease;
    }
    
    body.loaded {
      opacity: 1;
      transform: translateY(0);
    }
    
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      text-align: center;
      position: relative;
      padding: 20px 0;
    }
    
    .logo-container {
      position: relative;
      transform-style: preserve-3d;
    }
    
    .logo {
      width: 90px;
      height: 90px;
      border-radius: 20px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      object-fit: cover;
    }
    
    .logo:hover {
      transform: rotateY(10deg) scale(1.05);
      box-shadow: var(--box-shadow-hover);
    }
    
    h1 {
      color: var(--primary);
      margin: 0;
      font-size: 2.5rem;
      font-weight: 800;
      text-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 40px;
      font-size: 1.2rem;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.7;
      font-weight: 400;
    }
    
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      z-index: 1000;
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: var(--box-shadow-hover);
    }
    
    .mode-selector {
      text-align: center;
      margin: 40px 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .mode-btn {
      margin: 0;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--card-bg);
      color: var(--text-color);
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      transition: var(--transition);
      box-shadow: var(--box-shadow);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }
    
    .mode-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient);
      transition: var(--transition);
      z-index: -1;
    }
    
    .mode-btn:hover {
      transform: translateY(-5px);
      box-shadow: var(--box-shadow-hover);
      border-color: var(--primary);
    }
    
    .mode-btn.active {
      background: var(--gradient);
      color: white;
      border-color: transparent;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    
    .mode-btn.active::before {
      left: 0;
    }
    
    .upload-section {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 40px;
      opacity: 0;
      transform: translateY(30px);
    }
    
    .upload-section.active {
      opacity: 1;
      transform: translateY(0);
    }
    
    .upload-container {
      width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    
    .image-box {
      width: 100%;
      height: 420px;
      border: 3px dashed var(--gray-light);
      background: linear-gradient(145deg, var(--card-bg), var(--light));
      position: relative;
      overflow: hidden;
      border-radius: var(--border-radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      box-shadow: var(--box-shadow);
    }
    
    .image-box:hover {
      border-color: var(--primary);
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--box-shadow-hover);
    }
    
    .image-box.has-image {
      border-style: solid;
      border-color: var(--success);
      animation: pulse-success 2s infinite;
    }
    
    @keyframes pulse-success {
      0%, 100% { border-color: var(--success); }
      50% { border-color: #2ecc71; }
    }
    
    .image-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: var(--transition);
    }
    
    .upload-placeholder {
      text-align: center;
      color: var(--text-muted);
      padding: 30px;
      transition: var(--transition);
    }
    
    .upload-icon {
      font-size: 70px;
      margin-bottom: 20px;
      color: var(--primary);
      transition: var(--transition);
    }
    
    .upload-text {
      font-size: 18px;
      margin-bottom: 20px;
      font-weight: 500;
      color: var(--text-color);
    }
    
    .upload-btn {
      padding: 12px 24px;
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .upload-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    .label {
      position: absolute;
      top: 15px;
      left: 15px;
      background: var(--gradient);
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 20px;
      z-index: 10;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    button {
      margin: 12px;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      transition: var(--transition);
      box-shadow: var(--box-shadow);
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transition: var(--transition);
      transform: translate(-50%, -50%);
    }
    
    button:hover::after {
      width: 300px;
      height: 300px;
    }
    
    button:hover {
      transform: translateY(-5px);
      box-shadow: var(--box-shadow-hover);
    }
    
    button.secondary {
      background: linear-gradient(135deg, #8e2de2, #4a00e0);
    }
    
    button.secondary:hover {
      background: linear-gradient(135deg, #7d1dcf, #3a00b8);
    }
    
    #previewContainer {
      margin-top: 50px;
      text-align: center;
      display: none;
      background: var(--card-bg);
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      opacity: 0;
      transform: scale(0.9);
      transition: background 0.3s ease;
    }
    
    #previewContainer.show {
      opacity: 1;
      transform: scale(1);
    }
    
    #previewContainer img {
      width: 5cm;
      height: 15cm;
      object-fit: cover;
      border: 1px solid var(--gray-light);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      image-rendering: crisp-edges;
      border-radius: 8px;
      transition: var(--transition);
    }
    
    #previewContainer.double img {
      width: 10cm;
      height: 15cm;
    }
    
    .controls {
      text-align: center;
      margin-top: 40px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }
    
    .instructions {
      margin-top: 40px;
      padding: 30px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      display: none;
      box-shadow: var(--box-shadow);
      border-left: 6px solid var(--primary);
      opacity: 0;
      transform: translateX(-20px);
      transition: background 0.3s ease;
    }
    
    .instructions.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .instructions h4 {
      margin-top: 0;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.3rem;
      margin-bottom: 15px;
    }
    
    .instructions p {
      margin: 12px 0;
      line-height: 1.7;
      color: var(--text-color);
      font-size: 1.05rem;
    }
    
    footer {
      margin-top: 60px;
      padding: 25px;
      text-align: center;
      background: var(--gradient);
      color: white;
      border-radius: var(--border-radius);
      font-size: 15px;
      opacity: 0;
    }
    
    footer.show {
      opacity: 1;
    }
    
    .file-input {
      display: none;
    }
    
    .section-title {
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--text-color);
      text-align: center;
      font-size: 1.3rem;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .url-input-container {
      margin-top: 25px;
      text-align: center;
      width: 100%;
    }

    .url-input-container input {
      width: 85%;
      padding: 12px 16px;
      margin-bottom: 12px;
      border: 2px solid var(--gray-light);
      border-radius: 50px;
      font-size: 15px;
      transition: var(--transition);
      background: var(--card-bg);
      color: var(--text-color);
    }

    .url-input-container input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .url-input-container button {
      padding: 10px 20px;
      font-size: 15px;
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: var(--transition);
      margin: 0;
    }

    .url-input-container button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(102, 126, 234, 0.4);
    }
    
    /* Loading animations */
    .loading-spinner {
      display: none;
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-light);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Success animation */
    .success-checkmark {
      display: none;
      width: 60px;
      height: 60px;
      margin: 20px auto;
    }
    
    .check-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: block;
      stroke-width: 2;
      stroke: #4bb71b;
      stroke-miterlimit: 10;
      box-shadow: inset 0px 0px 0px #4bb71b;
      animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
    }
    
    .check-icon__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      stroke: #4bb71b;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    
    .check-icon__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    
    @keyframes stroke {
      100% { stroke-dashoffset: 0; }
    }
    
    @keyframes scale {
      0%, 100% { transform: none; }
      50% { transform: scale3d(1.1, 1.1, 1); }
    }
    
    @keyframes fill {
      100% { box-shadow: inset 0px 0px 0px 30px #4bb71b; }
    }
    
    /* Floating animation for elements */
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    
    @keyframes floating {
      0% { transform: translate(0, 0px); }
      50% { transform: translate(0, -15px); }
      100% { transform: translate(0, 0px); }
    }
    
    /* Particle effects */
    .particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .particle {
      position: absolute;
      background: var(--primary);
      border-radius: 50%;
      opacity: 0;
    }
    
    @media (max-width: 768px) {
      .upload-section {
        flex-direction: column;
        align-items: center;
      }
      
      .upload-container {
        width: 100%;
        max-width: 400px;
      }
      
      .image-box {
        height: 350px;
      }
      
      .controls {
        flex-direction: column;
        align-items: center;
      }
      
      button {
        width: 85%;
        max-width: 300px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .theme-toggle {
        position: relative;
        top: auto;
        right: auto;
        margin: 10px auto;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo-container">
      <img src="https://res.cloudinary.com/dipv76dpn/image/upload/v1759597977/undefined_Quiero_una_mezcla_de_d4pb5v.png" alt="Logo MarcaLibros" class="logo floating">
    </div>
    <h1>MarcaLibros Personalizados</h1>
    <button class="theme-toggle" id="themeToggle">
      <i class="bi bi-moon-fill"></i>
    </button>
  </div>
  <p class="subtitle">Transforma tus im√°genes en separadores √∫nicos: dise√±o de una o doble cara, optimizados para impresi√≥n profesional</p>

  <div class="mode-selector">
    <button class="mode-btn active" data-mode="single">
      <i class="bi bi-file-image"></i> Una cara
    </button>
    <button class="mode-btn" data-mode="double">
      <i class="bi bi-files"></i> Doble cara
    </button>
  </div>

  <!-- Modo Una Cara -->
  <div class="upload-section single-mode active">
    <div class="upload-container">
      <p class="section-title">Imagen para tu separador</p>
      <div class="image-box" id="box1">
        <div class="upload-placeholder">
          <i class="bi bi-cloud-upload upload-icon"></i>
          <div class="upload-text">Sube tu imagen para el separador</div>
          <button class="upload-btn">Seleccionar imagen</button>
        </div>
        <img id="image1" src="" alt="Imagen 1" />
        <div class="label">Cara 1</div>
      </div>
      <input type="file" id="imageUpload1" accept="image/*" class="file-input" />
      <div class="url-input-container">
        <input type="text" id="imageUrl1" placeholder="Pega la URL de una imagen..." />
        <button onclick="loadImageFromUrl('imageUrl1', 'image1', 'box1')">Cargar desde URL</button>
      </div>
    </div>
  </div>

  <!-- Modo Doble Cara -->
  <div class="upload-section double-mode" style="display:none;">
    <div class="upload-container">
      <p class="section-title">Imagen para la cara frontal</p>
      <div class="image-box" id="box1_double">
        <div class="upload-placeholder">
          <i class="bi bi-cloud-upload upload-icon"></i>
          <div class="upload-text">Sube imagen para la cara frontal</div>
          <button class="upload-btn">Seleccionar imagen</button>
        </div>
        <img id="image1_double" src="" alt="Imagen 1" />
        <div class="label">Cara 1</div>
      </div>
      <input type="file" id="imageUpload1_double" accept="image/*" class="file-input" />
      <div class="url-input-container">
        <input type="text" id="imageUrl1_double" placeholder="Pega la URL de la imagen frontal..." />
        <button onclick="loadImageFromUrl('imageUrl1_double', 'image1_double', 'box1_double')">Cargar desde URL</button>
      </div>
    </div>
    
    <div class="upload-container">
      <p class="section-title">Imagen para la cara trasera</p>
      <div class="image-box" id="box2_double">
        <div class="upload-placeholder">
          <i class="bi bi-cloud-upload upload-icon"></i>
          <div class="upload-text">Sube imagen para la cara trasera</div>
          <button class="upload-btn">Seleccionar imagen</button>
        </div>
        <img id="image2_double" src="" alt="Imagen 2" />
        <div class="label">Cara 2</div>
      </div>
      <input type="file" id="imageUpload2_double" accept="image/*" class="file-input" />
      <div class="url-input-container">
        <input type="text" id="imageUrl2_double" placeholder="Pega la URL de la imagen trasera..." />
        <button onclick="loadImageFromUrl('imageUrl2_double', 'image2_double', 'box2_double')">Cargar desde URL</button>
      </div>
    </div>
  </div>

  <div class="controls">
    <button id="cropButton"><i class="bi bi-scissors"></i> Recortar imagen(es)</button>
    <button id="downloadPdfButton" style="display:none;" class="secondary"><i class="bi bi-file-pdf"></i> PDF (imprimir)</button>
    <button id="downloadPngButton" style="display:none;"><i class="bi bi-image"></i> PNG (alta calidad)</button>
    <button id="downloadJpgButton" style="display:none;"><i class="bi bi-camera"></i> JPG (compartir)</button>
    <button id="uploadToCloudinaryButton" style="display:none;" class="secondary">
      <i class="bi bi-cloud-arrow-up"></i> Subir a Cloudinary
    </button>
  </div>

  <div class="loading-spinner" id="loadingSpinner"></div>
  <div class="success-checkmark" id="successCheckmark">
    <svg class="check-icon" viewBox="0 0 52 52">
      <circle class="check-icon__circle" cx="26" cy="26" r="25" fill="none"/>
      <path class="check-icon__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    </svg>
  </div>

  <div id="previewContainer">
    <h3>Tu separador final:</h3>
    <img id="finalPreview" src="" alt="Separador" />
  </div>

  <div class="instructions" id="instructions">
    <h4><i class="bi bi-info-circle"></i> Instrucciones de impresi√≥n y armado:</h4>
    <p id="instructionText"></p>
  </div>

  <footer>
    ¬© 2025 Jhorman Jes√∫s Castellanos Morales ‚Äì Todos los derechos reservados.
  </footer>

  <!-- Librer√≠as -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  
  <script>
    // Funci√≥n para alternar entre modo claro y oscuro
    function toggleTheme() {
      const body = document.body;
      const themeToggle = document.getElementById('themeToggle');
      const icon = themeToggle.querySelector('i');
      
      body.classList.toggle('dark-mode');
      
      if (body.classList.contains('dark-mode')) {
        icon.classList.remove('bi-moon-fill');
        icon.classList.add('bi-sun-fill');
        localStorage.setItem('theme', 'dark');
      } else {
        icon.classList.remove('bi-sun-fill');
        icon.classList.add('bi-moon-fill');
        localStorage.setItem('theme', 'light');
      }
    }
    
    // Aplicar tema guardado al cargar la p√°gina
    function applySavedTheme() {
      const savedTheme = localStorage.getItem('theme');
      const body = document.body;
      const themeToggle = document.getElementById('themeToggle');
      const icon = themeToggle.querySelector('i');
      
      if (savedTheme === 'dark') {
        body.classList.add('dark-mode');
        icon.classList.remove('bi-moon-fill');
        icon.classList.add('bi-sun-fill');
      } else {
        body.classList.remove('dark-mode');
        icon.classList.remove('bi-sun-fill');
        icon.classList.add('bi-moon-fill');
      }
    }
    
    // Inicializar animaciones al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      // Aplicar tema guardado
      applySavedTheme();
      
      // Configurar evento para el bot√≥n de tema
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // Animaci√≥n de entrada para toda la p√°gina
      anime({
        targets: 'body',
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 800,
        easing: 'easeOutCubic'
      });
      
      // Animaci√≥n del logo
      anime({
        targets: '.logo',
        rotateY: [180, 0],
        scale: [0.8, 1],
        duration: 1000,
        delay: 300,
        easing: 'easeOutElastic(1, .8)'
      });
      
      // Animaci√≥n del t√≠tulo
      anime({
        targets: 'h1',
        opacity: [0, 1],
        translateY: [30, 0],
        duration: 800,
        delay: 500,
        easing: 'easeOutCubic'
      });
      
      // Animaci√≥n del subt√≠tulo
      anime({
        targets: '.subtitle',
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 600,
        delay: 700,
        easing: 'easeOutCubic'
      });
      
      // Animaci√≥n de los botones de modo
      anime({
        targets: '.mode-btn',
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 600,
        delay: function(el, i) {
          return 900 + (i * 100);
        },
        easing: 'easeOutCubic'
      });
      
      // Animaci√≥n de las secciones de upload
      anime({
        targets: '.upload-section.active',
        opacity: [0, 1],
        translateY: [30, 0],
        duration: 800,
        delay: 1100,
        easing: 'easeOutCubic'
      });
      
      // Animaci√≥n del footer
      anime({
        targets: 'footer',
        opacity: [0, 1],
        duration: 600,
        delay: 1500,
        easing: 'easeOutCubic'
      });
      
      // Marcar body como cargado
      document.body.classList.add('loaded');
    });

    let cropper1, cropper2;
    let croppedCanvas1, croppedCanvas2;
    let currentMode = 'single';

    // Animaci√≥n para cambiar modo
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Animaci√≥n de part√≠culas en el bot√≥n clickeado
        createParticles(this);
        
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentMode = this.dataset.mode;

        const singleSection = document.querySelector('.single-mode');
        const doubleSection = document.querySelector('.double-mode');
        const previewContainer = document.getElementById('previewContainer');
        const instructions = document.getElementById('instructions');
        const cropButton = document.getElementById('cropButton');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        const downloadPngButton = document.getElementById('downloadPngButton');
        const downloadJpgButton = document.getElementById('downloadJpgButton');
        const uploadToCloudinaryButton = document.getElementById('uploadToCloudinaryButton');

        if (currentMode === 'single') {
          // Animaci√≥n de transici√≥n entre modos
          anime({
            targets: doubleSection,
            opacity: [1, 0],
            translateY: [0, -20],
            duration: 400,
            easing: 'easeInOutQuad',
            complete: function() {
              doubleSection.style.display = 'none';
              singleSection.style.display = 'flex';
              anime({
                targets: singleSection,
                opacity: [0, 1],
                translateY: [20, 0],
                duration: 500,
                easing: 'easeOutCubic'
              });
            }
          });
        } else {
          anime({
            targets: singleSection,
            opacity: [1, 0],
            translateY: [0, -20],
            duration: 400,
            easing: 'easeInOutQuad',
            complete: function() {
              singleSection.style.display = 'none';
              doubleSection.style.display = 'flex';
              anime({
                targets: doubleSection,
                opacity: [0, 1],
                translateY: [20, 0],
                duration: 500,
                easing: 'easeOutCubic'
              });
            }
          });
        }

        // Resetear
        anime({
          targets: [previewContainer, instructions],
          opacity: [1, 0],
          scale: [1, 0.9],
          duration: 300,
          easing: 'easeInQuad',
          complete: function() {
            previewContainer.style.display = 'none';
            instructions.style.display = 'none';
            previewContainer.classList.remove('show');
            instructions.classList.remove('show');
          }
        });
        
        cropButton.style.display = 'inline-block';
        downloadPdfButton.style.display = 'none';
        downloadPngButton.style.display = 'none';
        downloadJpgButton.style.display = 'none';
        uploadToCloudinaryButton.style.display = 'none';

        if (cropper1) cropper1.destroy();
        if (cropper2) cropper2.destroy();
        cropper1 = cropper2 = null;
        document.getElementById('image1').src = '';
        document.getElementById('image1_double').src = '';
        document.getElementById('image2_double').src = '';
        
        // Resetear estado visual de las cajas
        document.querySelectorAll('.image-box').forEach(box => {
          box.classList.remove('has-image');
          box.querySelector('img').style.display = 'none';
          box.querySelector('.upload-placeholder').style.display = 'flex';
        });
      });
    });

    // Funci√≥n para crear efecto de part√≠culas
    function createParticles(element) {
      const rect = element.getBoundingClientRect();
      const particlesContainer = document.createElement('div');
      particlesContainer.className = 'particles';
      document.body.appendChild(particlesContainer);
      
      for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particlesContainer.appendChild(particle);
        
        const size = anime.random(5, 10);
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;
        
        anime({
          targets: particle,
          width: size,
          height: size,
          background: () => `hsl(${anime.random(0, 360)}, 70%, 60%)`,
          translateX: [x, x + anime.random(-100, 100)],
          translateY: [y, y + anime.random(-100, 100)],
          opacity: [1, 0],
          duration: anime.random(800, 1200),
          easing: 'easeOutExpo',
          complete: function() {
            particle.remove();
            if (particlesContainer.children.length === 0) {
              particlesContainer.remove();
            }
          }
        });
      }
    }

    // --- Eventos de carga de imagen ---
    function initCropper(imgElement) {
      return new Cropper(imgElement, {
        aspectRatio: 1 / 3,
        viewMode: 1,
        dragMode: 'move',
        cropBoxResizable: true,
        cropBoxMovable: true,
        guides: true,
        center: true,
        highlight: false,
        autoCropArea: 0.8,
        responsive: true,
        zoomOnWheel: true,
        zoomOnTouch: true,
      });
    }

    function setupImageUpload(inputId, imageId, boxId) {
      const input = document.getElementById(inputId);
      const image = document.getElementById(imageId);
      const box = document.getElementById(boxId);
      const placeholder = box.querySelector('.upload-placeholder');
      const uploadBtn = placeholder.querySelector('.upload-btn');
      
      uploadBtn.addEventListener('click', () => input.click());
      placeholder.addEventListener('click', e => {
        if (e.target === placeholder) input.click();
      });
      
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = event => {
          image.src = event.target.result;
          image.style.display = 'block';
          placeholder.style.display = 'none';
          box.classList.add('has-image');
          
          // Animaci√≥n de la imagen cargada
          anime({
            targets: image,
            opacity: [0, 1],
            scale: [0.8, 1],
            duration: 600,
            easing: 'easeOutCubic'
          });
          
          // Animaci√≥n de la caja
          anime({
            targets: box,
            scale: [1, 1.05, 1],
            duration: 600,
            easing: 'easeOutElastic(1, .8)'
          });
          
          // Inicializar cropper despu√©s de que la imagen est√© completamente cargada
          setTimeout(() => {
            if (boxId === 'box1' || boxId === 'box1_double') {
              if (cropper1) cropper1.destroy();
              cropper1 = initCropper(image);
            } else if (boxId === 'box2_double') {
              if (cropper2) cropper2.destroy();
              cropper2 = initCropper(image);
            }
          }, 100);
        };
        reader.readAsDataURL(file);
      });
    }

    setupImageUpload('imageUpload1', 'image1', 'box1');
    setupImageUpload('imageUpload1_double', 'image1_double', 'box1_double');
    setupImageUpload('imageUpload2_double', 'image2_double', 'box2_double');

    // --- Cargar imagen desde URL ---
    function loadImageFromUrl(inputId, imageId, boxId) {
      const urlInput = document.getElementById(inputId);
      const imageUrl = urlInput.value.trim();
      
      if (!imageUrl) {
        showNotification("Por favor, pega una URL v√°lida.", "error");
        return;
      }

      if (!/^https?:\/\//i.test(imageUrl)) {
        showNotification("La URL debe comenzar con http:// o https://", "error");
        return;
      }

      const image = document.getElementById(imageId);
      const box = document.getElementById(boxId);
      const placeholder = box.querySelector('.upload-placeholder');

      // Mostrar loading
      placeholder.innerHTML = '<div style="text-align: center; color: var(--text-muted);"><i class="bi bi-hourglass-split" style="font-size: 40px;"></i><div style="margin-top: 15px;">Cargando imagen...</div></div>';

      // Limpiar eventos anteriores para evitar duplicados
      image.onload = null;
      image.onerror = null;

      image.onload = function() {
        image.style.display = 'block';
        placeholder.style.display = 'none';
        box.classList.add('has-image');
        
        // Animaci√≥n de √©xito
        anime({
          targets: image,
          opacity: [0, 1],
          scale: [0.8, 1],
          duration: 600,
          easing: 'easeOutCubic'
        });
        
        anime({
          targets: box,
          scale: [1, 1.05, 1],
          duration: 600,
          easing: 'easeOutElastic(1, .8)'
        });
        
        // Inicializar cropper despu√©s de un peque√±o delay para asegurar que la imagen est√© completamente cargada
        setTimeout(() => {
          if (boxId === 'box1' || boxId === 'box1_double') {
            if (cropper1) cropper1.destroy();
            cropper1 = initCropper(image);
          } else if (boxId === 'box2_double') {
            if (cropper2) cropper2.destroy();
            cropper2 = initCropper(image);
          }
        }, 300);
        
        showNotification("¬°Imagen cargada correctamente!", "success");
      };

      image.onerror = function() {
        showNotification("‚ùå No se pudo cargar la imagen desde la URL. Verifica que sea accesible y p√∫blica.", "error");
        placeholder.innerHTML = `
          <i class="bi bi-cloud-upload upload-icon"></i>
          <div class="upload-text">Sube tu imagen para el separador</div>
          <button class="upload-btn">Seleccionar imagen</button>
        `;
        image.src = '';
        image.style.display = 'none';
        box.classList.remove('has-image');
      };

      image.src = imageUrl;
    }

    // Funci√≥n para mostrar notificaciones
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? 'linear-gradient(135deg, #4cc9f0, #4361ee)' : 'linear-gradient(135deg, #f72585, #7209b7)'};
        color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        z-index: 10000;
        max-width: 300px;
        transform: translateX(100px);
        opacity: 0;
        transition: var(--transition);
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Animaci√≥n de entrada
      anime({
        targets: notification,
        translateX: [100, 0],
        opacity: [0, 1],
        duration: 500,
        easing: 'easeOutCubic'
      });
      
      // Auto-eliminar despu√©s de 4 segundos
      setTimeout(() => {
        anime({
          targets: notification,
          translateX: [0, 100],
          opacity: [1, 0],
          duration: 500,
          easing: 'easeInCubic',
          complete: function() {
            notification.remove();
          }
        });
      }, 4000);
    }

    // --- Recortar ---
    document.getElementById('cropButton').addEventListener('click', function() {
      // Animaci√≥n del bot√≥n
      anime({
        targets: this,
        scale: [1, 0.95, 1],
        duration: 300,
        easing: 'easeInOutQuad'
      });
      
      if (currentMode === 'single') {
        if (!cropper1) {
          showNotification("Por favor, sube y recorta la imagen.", "error");
          return;
        }
        croppedCanvas1 = cropper1.getCroppedCanvas({ width: 500, height: 1500 });
        showResult(croppedCanvas1);
      } else {
        if (!cropper1 || !cropper2) {
          showNotification("Por favor, sube y recorta ambas im√°genes.", "error");
          return;
        }
        croppedCanvas1 = cropper1.getCroppedCanvas({ width: 500, height: 1500 });
        croppedCanvas2 = cropper2.getCroppedCanvas({ width: 500, height: 1500 });

        const combinedCanvas = document.createElement('canvas');
        combinedCanvas.width = 1000;
        combinedCanvas.height = 1500;
        const ctx = combinedCanvas.getContext('2d');
        ctx.drawImage(croppedCanvas1, 0, 0);
        ctx.drawImage(croppedCanvas2, 500, 0);
        showResult(combinedCanvas);
      }
    });

    function showResult(canvas) {
      const preview = document.getElementById('finalPreview');
      const previewContainer = document.getElementById('previewContainer');
      const instructions = document.getElementById('instructions');
      
      preview.src = canvas.toDataURL();
      previewContainer.classList.toggle('double', currentMode === 'double');
      previewContainer.style.display = 'block';
      
      // Animaci√≥n de la vista previa
      anime({
        targets: previewContainer,
        opacity: [0, 1],
        scale: [0.9, 1],
        duration: 700,
        easing: 'easeOutElastic(1, .8)',
        complete: function() {
          previewContainer.classList.add('show');
        }
      });
      
      // Animaci√≥n de la imagen de vista previa
      anime({
        targets: preview,
        opacity: [0, 1],
        scale: [0.8, 1],
        duration: 600,
        delay: 300,
        easing: 'easeOutCubic'
      });
      
      document.getElementById('downloadPdfButton').style.display = 'inline-block';
      document.getElementById('downloadPngButton').style.display = 'inline-block';
      document.getElementById('downloadJpgButton').style.display = 'inline-block';
      document.getElementById('uploadToCloudinaryButton').style.display = 'inline-block';
      
      // Mostrar instrucciones con animaci√≥n
      instructions.style.display = 'block';
      anime({
        targets: instructions,
        opacity: [0, 1],
        translateX: [-20, 0],
        duration: 600,
        delay: 500,
        easing: 'easeOutCubic',
        complete: function() {
          instructions.classList.add('show');
        }
      });

      const instructionText = document.getElementById('instructionText');
      if (currentMode === 'single') {
        instructionText.innerHTML = `
          <strong>üìÑ Medidas:</strong> 5 cm de ancho √ó 15 cm de alto.<br>
          <strong>üñ®Ô∏è Impresi√≥n:</strong> Papel opalina brillante o mate (180‚Äì250 g/m¬≤).<br>
          <strong>‚úÇÔ∏è Armado:</strong> Recorta con tijeras. ¬°Listo para usar!
        `;
      } else {
        instructionText.innerHTML = `
          <strong>üìÑ Medidas:</strong> 10 cm de ancho √ó 15 cm de alto (5 cm por cara).<br>
          <strong>üñ®Ô∏è Impresi√≥n:</strong> Papel opalina o fotogr√°fico (200‚Äì250 g/m¬≤).<br>
          <strong>‚úÇÔ∏è Armado:</strong> Recorta, dobla por la mitad y pega con pegamento en barra.
        `;
      }
      window.finalCanvas = canvas;
      
      // Mostrar √©xito
      showNotification("¬°Separador creado con √©xito!", "success");
    }

    // --- Descargas ---
    document.getElementById('downloadPdfButton').addEventListener('click', function() {
      // Animaci√≥n de carga
      const spinner = document.getElementById('loadingSpinner');
      spinner.style.display = 'block';
      
      setTimeout(() => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        const imgData = window.finalCanvas.toDataURL('image/png');
        const widthMM = currentMode === 'single' ? 50 : 100;
        const heightMM = 150;
        const x = (210 - widthMM) / 2;
        const y = (297 - heightMM) / 2;
        doc.addImage(imgData, 'PNG', x, y, widthMM, heightMM);
        doc.setFontSize(16);
        doc.text(`Separador de ${currentMode === 'single' ? 'una cara' : 'doble cara'}`, x, y - 5);
        doc.setFontSize(10);
        doc.text([
          `‚Ä¢ Medidas: ${widthMM}mm √ó ${heightMM}mm`,
          `‚Ä¢ Papel: Opalina o fotogr√°fico (200‚Äì250 g/m¬≤)`,
          `‚Ä¢ Armado: Recortar y, si es doble cara, doblar y pegar.`
        ], x, y + heightMM + 15, { maxWidth: 180 });
        doc.save(currentMode === 'single' ? 'separador-una-cara.pdf' : 'separador-doble-cara.pdf');
        
        // Ocultar spinner y mostrar √©xito
        spinner.style.display = 'none';
        showNotification("PDF descargado correctamente", "success");
      }, 800);
    });

    document.getElementById('downloadPngButton').addEventListener('click', function() {
      const link = document.createElement('a');
      link.download = currentMode === 'single' ? 'separador-una-cara.png' : 'separador-doble-cara.png';
      link.href = window.finalCanvas.toDataURL('image/png');
      link.click();
      showNotification("PNG descargado correctamente", "success");
    });

    document.getElementById('downloadJpgButton').addEventListener('click', function() {
      const link = document.createElement('a');
      link.download = currentMode === 'single' ? 'separador-una-cara.jpg' : 'separador-doble-cara.jpg';
      link.href = window.finalCanvas.toDataURL('image/jpeg', 0.95);
      link.click();
      showNotification("JPG descargado correctamente", "success");
    });

    // --- Subir a Cloudinary ---
    const CLOUD_NAME = 'dipv76dpn';
    const UPLOAD_PRESET = 'separadores-preset';

    function uploadToCloudinary(canvas) {
      const spinner = document.getElementById('loadingSpinner');
      spinner.style.display = 'block';
      
      const formData = new FormData();
      canvas.toBlob(blob => {
        formData.append('file', blob, 'separador.png');
        formData.append('upload_preset', UPLOAD_PRESET);
        formData.append('folder', 'Separadores');

        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          spinner.style.display = 'none';
          if (data.secure_url) {
            const url = data.secure_url;
            showNotification("‚úÖ ¬°Subido a Cloudinary con √©xito!", "success");
            showUploadSuccess(url);
          } else {
            throw new Error('Respuesta inv√°lida de Cloudinary');
          }
        })
        .catch(error => {
          spinner.style.display = 'none';
          console.error('Error al subir:', error);
          showNotification("‚ùå Error al subir a Cloudinary", "error");
        });
      }, 'image/png');
    }

    function showUploadSuccess(url) {
      const instructionText = document.getElementById('instructionText');
      instructionText.innerHTML += `
        <br><hr><br>
        <strong>üîó URL p√∫blica del separador:</strong><br>
        <input type="text" value="${url}" readonly style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid var(--gray-light); border-radius: 50px; background: var(--card-bg); color: var(--text-color);">
        <button onclick="copyToClipboard('${url}')" style="margin-top: 10px; padding: 10px 20px; font-size: 14px; background: var(--gradient); color: white; border: none; border-radius: 50px; cursor: pointer; transition: var(--transition);">Copiar URL</button>
      `;
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showNotification("‚úÖ URL copiada al portapapeles", "success");
        }).catch(() => {
          fallbackCopyTextToClipboard(text);
        });
      } else {
        fallbackCopyTextToClipboard(text);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        showNotification(successful ? '‚úÖ URL copiada al portapapeles' : '‚ùå No se pudo copiar', 
                        successful ? "success" : "error");
      } catch (err) {
        showNotification('‚ùå No se pudo copiar. Por favor, seleccione y copie manualmente.', "error");
      }
      document.body.removeChild(textArea);
    }

    document.getElementById('uploadToCloudinaryButton').addEventListener('click', function() {
      if (window.finalCanvas) {
        uploadToCloudinary(window.finalCanvas);
      } else {
        showNotification("No hay un separador generado para subir.", "error");
      }
    });
  </script>
</body>
</html>
